# Руководство по воспроизведению проекта Instantum

## Обзор проекта

**Instantum** — это трекер задач с организационной структурой, аналогичный Basecamp. Позволяет создавать организации, проекты, назначать задачи и управлять командой.

## Первоначальная настройка перед началом работы

**ВАЖНО**: Выполни эти шаги перед началом разработки проекта. После каждого этапа должны проходить проверки как локально, так и в GitHub.

### Шаг 0: Подготовка окружения

1. **Создать Rails приложение** (см. раздел "Этап 1: Базовая настройка")
   - Создать проект с PostgreSQL и Tailwind CSS
   - Установить все необходимые гемы (см. "Этап 1: Базовая настройка")
   - Настроить базу данных

2. **Настроить Git репозиторий**
   - Создать репозиторий `inst06` на GitHub
   - Инициализировать Git в рабочей папке проекта
   - Связать локальную папку с удаленным репозиторием `inst06`
   - Создать `.gitignore` и сделать первый коммит базовой структуры проекта

3. **Запустить локальный сервер**
   - Остановить все запущенные Rails серверы (проверить процессы на порту 3000)
   - Запустить `bin/dev` для локальной разработки
   - Убедиться, что сервер работает на `localhost:3000`
   - **НЕ ПРОДОЛЖАТЬ** до подтверждения пользователем, что сервер запущен

4. **Проверка пользователем**
   - После выполнения шагов 1-3 остановиться и сообщить пользователю
   - Дождаться подтверждения, что все работает корректно
   - Только после подтверждения переходить к следующему этапу

### Шаг 1: Начало разработки

После подтверждения от пользователя начинать работу по этапам (см. "Пошаговый план реализации"):

- **Каждый этап** должен завершаться коммитом с осмысленным сообщением
- **После каждого этапа** запускать тесты локально (см. "Этап 5: Тестирование")
- **После каждого коммита** проверять статус CI/CD в GitHub Actions (см. "Git и управление проектом")
- **При ошибках CI** исправлять их немедленно перед переходом к следующему этапу

**Принцип работы**: Итеративно, небольшими шагами, с тестированием на каждом этапе. Никогда не переходить к следующему этапу, если текущий не работает локально и в CI.

**Обязательные проверки после каждого этапа:**
- ✅ Локальное тестирование: `bundle exec rspec` - все тесты должны проходить
- ✅ Локальный запуск: сервер работает, страницы открываются без ошибок
- ✅ Коммит и push: изменения закоммичены и отправлены в GitHub
- ✅ CI проверка: GitHub Actions проходят успешно (linting, tests, security)
- ✅ Только после всех зеленых галочек переходить к следующему этапу

См. также разделы: "Этап 5: Тестирование", "Git и управление проектом", "Ключевые принципы" (пункт 6 - Итеративность).

## Архитектура системы

### Основные сущности
- **User** — пользователи системы (аутентификация через Devise)
- **Organization** — организации/компании (мультитенантность)
- **Membership** — связь пользователь-организация с ролями (owner, admin, member, guest)
- **Project** — проекты внутри организации
- **Task** — задачи внутри проекта с назначением и статусами

### Ключевые особенности реализации
- **Автоматическое создание организации**: При регистрации пользователя автоматически создается его первая организация с ролью owner
- **Session-based переключение**: Текущая организация сохраняется в session для переключения между организациями
- **Graceful error handling**: Корректная обработка RecordNotFound и NotAuthorized ошибок с редиректами
- **Изоляция данных**: Все запросы автоматически фильтруются по текущей организации через Pundit scoping

### Роли и права доступа
- **Owner** — полный доступ, может удалять организацию, управлять всеми проектами и участниками
- **Admin** — управление проектами (CRUD), приглашение участников, изменение ролей (кроме owner)
- **Member** — создание и просмотр проектов и задач, редактирование назначенных на него задач
- **Guest** — только просмотр проектов и задач, без возможности создания или редактирования

### Детали авторизации
- Иерархия ролей: `owner > admin > member > guest`
- Owner не может быть удален из организации (защита от случайного удаления)
- Только owner может удалить организацию
- Guest не может создавать проекты и задачи
- Member не может редактировать/удалять проекты (только owner/admin)

### Технический стек
- **Backend**: Ruby on Rails 8.0
- **Database**: PostgreSQL (все окружения)
- **Authentication**: Devise (стандарт сообщества)
- **Authorization**: Pundit (стандарт сообщества)
- **Frontend**: Tailwind CSS + DaisyUI + Lucide иконки
- **JavaScript**: Turbo + Stimulus (Hotwire, встроено в Rails 8)
- **Testing**: RSpec + FactoryBot + Capybara (стандарт сообщества)
- **Admin Panel**: Avo (development only)
- **Performance**: Solid Cache, Solid Queue, Solid Cable (Rails 8)

## Пошаговый план реализации

### Этап 1: Базовая настройка

1. **Создание Rails приложения**
   - `rails new project_name --database=postgresql --css=tailwindcss`
   - Настройка `.gitignore`
   - Инициализация Git репозитория

2. **Установка гемов**
   - Devise для аутентификации (стандарт сообщества)
   - Pundit для авторизации (стандарт сообщества)
   - Avo для админ-панели (development)
   - RSpec + FactoryBot + Faker для тестирования (стандарт сообщества)
   - dotenv-rails для переменных окружения

3. **Настройка базы данных**
   - PostgreSQL для всех окружений (development, test, production)
   - Настройка `config/database.yml` с правильными credentials
   - Первый `rails db:create`

### Этап 2: Модели и миграции

1. **User модель (Devise)**
   - `rails generate devise User`
   - Настройка маршрутов
   - Кастомизация views

2. **Остальные модели**
   - Organization (name, plan)
   - Membership (user, organization, role)
   - Project (organization, name, description)
   - Task (project, title, description, status, creator, assigned_user)

3. **Связи и валидации**
   - has_many/belongs_to ассоциации
   - Уникальные индексы
   - NOT NULL ограничения

4. **Seed данные**
   - Тестовые пользователи
   - Организации с разными планами
   - Проекты и задачи

### Этап 3: Контроллеры и авторизация

1. **Pundit настройка**
   - ApplicationController с rescue_from
   - Политики для всех моделей
   - current_organization helper

2. **CRUD контроллеры**
   - ProjectsController с изоляцией по организации
   - TasksController (nested в projects)
   - MembershipsController для управления командой
   - OrganizationsController для переключения

3. **Маршруты**
   - Nested resources для tasks
   - Custom actions (assign_to_me, switch_organization)
   - Avo admin panel

### Этап 4: Views и UI

1. **Layout и навигация**
   - Navbar с переключением организаций
   - Breadcrumbs helper
   - Flash messages

2. **Основные страницы**
   - Home page с таблицей организаций
   - Projects index/show/edit
   - Tasks index/show/edit с фильтрами
   - Memberships management

3. **DaisyUI + Lucide интеграция**
   - Установка DaisyUI через npm
   - Установка Lucide иконок (только нужные)
   - Настройка Tailwind config
   - Конвертация всех views на DaisyUI компоненты
   - Добавление иконок по необходимости (tree-shaking)

### Этап 5: Тестирование

1. **RSpec настройка**
   - FactoryBot factories
   - System tests с Capybara
   - Policy tests

2. **GitHub Actions**
   - CI/CD pipeline
   - Linting (Rubocop)
   - Security scanning (Brakeman + Bundler Audit)
   - Database setup для CI
   - Автоматические проверки на уязвимости зависимостей

3. **Тестовые данные**
   - Comprehensive seed file
   - Different user roles
   - Realistic project/task data

## Критические принципы и подходы

### Архитектурные решения
- **Мультитенантность**: Реализовать через `current_organization` helper и Pundit scoping. Всегда изолировать данные по организации. **Важно**: Session-based переключение должно быть реализовано с самого начала.
- **Авторизация**: Использовать иерархию ролей `owner > admin > member > guest`. Политики должны быть простыми и понятными. **Критично**: Policy scope должен фильтровать по текущей организации, а не показывать все данные пользователя.
- **Производительность**: С самого начала добавлять индексы на foreign keys и часто используемые поля. Использовать eager loading и избегать N+1 запросов. Добавлять NOT NULL constraints в миграциях.
- **Безопасность**: Уникальные индексы на составные ключи (например, user_id + organization_id) должны быть в базе данных, а не только в валидациях модели.

### Frontend подход
- **Стили**: Tailwind + DaisyUI для консистентного дизайна. Убедиться, что скомпилированные стили правильно подключаются.
- **Иконки**: Использовать tree-shaking для минимизации bundle size. Импортировать только необходимые иконки.
- **UX**: Следовать принципам аскетичного дизайна - простые формы, консистентные кнопки, четкая иерархия.

### Разработка и тестирование
- **Тестирование**: Покрыть все основные сценарии через RSpec + Capybara. Включить тесты для политик авторизации.
- **CI/CD**: Настроить автоматические проверки с правильными credentials для PostgreSQL.
- **Seed данные**: Создать реалистичные тестовые данные для всех ролей и сценариев использования.

### Технические нюансы
- **Сервер**: Перезапускать после установки гемов и изменений конфигурации.
- **База данных**: Использовать PostgreSQL везде для консистентности окружений.
- **Кеширование**: Настроить Solid Cache для улучшения производительности.

### Git и DevOps
- **Версионирование**: Создавать осмысленные коммиты с описательными сообщениями.
- **CI/CD**: Настроить автоматические проверки кода, тестирование и деплой.
- **Мониторинг**: Отслеживать статус сборок и исправлять ошибки в CI pipeline.
- **Документация**: Ведение changelog и обновление документации при изменениях.

## Типичные ошибки и как их избежать

### Архитектурные ошибки
- ❌ **Не реализовать переключение организаций сразу** → Реализовать session-based переключение с самого начала
- ❌ **Policy scope показывает все организации** → Всегда фильтровать по `current_organization`
- ❌ **Отсутствие уникальных индексов** → Добавлять составные уникальные индексы в миграциях
- ❌ **Забыть creator_id** → Включать все поля из архитектуры с самого начала
- ❌ **Нет NOT NULL constraints** → Добавлять ограничения в миграциях, а не только валидации

### Производительность
- ❌ **Отсутствие индексов на foreign keys** → Добавлять индексы на все foreign keys сразу
- ❌ **N+1 запросы** → Использовать eager loading для связанных данных
- ❌ **Отсутствие индексов на часто фильтруемые поля** → Индексировать status, role и другие поля фильтрации

### Безопасность
- ❌ **Только валидации в модели** → Добавлять уникальные индексы в БД для защиты от race conditions
- ❌ **Отсутствие graceful error handling** → Реализовать rescue_from для RecordNotFound и NotAuthorized
- ❌ **Guest может создавать ресурсы** → Правильно настроить политики авторизации

### Разработка
- ❌ **Не перезапускать сервер после bundle install** → Всегда перезапускать после установки гемов
- ❌ **Стили не применяются** → Проверить подключение скомпилированных стилей из builds/tailwind.css
- ❌ **CI падает из-за PostgreSQL credentials** → Использовать правильного пользователя в CI (postgres, не root)

## Ожидаемое время реализации

- **Опытный разработчик**: 4-5 часов
- **Средний уровень**: 6-8 часов
- **Новичок**: 10-12 часов

## Ключевые файлы для изучения

При воспроизведении проекта стоит изучить структуру следующих файлов:
- **Gemfile** — полный список зависимостей
- **config/routes.rb** — маршруты и nested resources
- **db/seeds.rb** — примеры тестовых данных
- **app/policies/** — политики авторизации
- **spec/factories/** — фабрики для тестов
- **.github/workflows/** — CI конфигурация

## Общий подход к реализации

### Инициализация проекта
- Создать Rails приложение с PostgreSQL и Tailwind CSS
- Настроить Git репозиторий с правильным `.gitignore`
- Установить все необходимые гемы для аутентификации, авторизации, тестирования и админ-панели

### Модели и база данных
- Создать все модели с правильными связями и валидациями
- Настроить foreign keys для всех references
- Добавить индексы для производительности
- Создать comprehensive seed данные

### Контроллеры и авторизация
- Настроить Pundit с политиками для всех моделей
- Реализовать CRUD операции с правильной изоляцией данных
- Добавить helper методы для работы с организациями

### Frontend и UI
- Настроить Tailwind CSS + DaisyUI
- Интегрировать иконки с tree-shaking
- Создать консистентный дизайн для всех страниц
- Реализовать навигацию и breadcrumbs

### Тестирование и CI
- Настроить RSpec с FactoryBot
- Создать system tests с Capybara
- Настроить GitHub Actions для автоматических проверок
- Покрыть все основные сценарии использования

### Git и управление проектом
- Инициализировать Git репозиторий с правильным `.gitignore`
- Настроить GitHub репозиторий с защищенными ветками
- Создавать осмысленные коммиты с описательными сообщениями
- Настроить GitHub Actions для автоматических проверок
- Мониторить статус CI/CD pipeline и исправлять ошибки
- Управлять ветками и pull requests
- Отслеживать изменения в коде и документации

## Заключение

Этот проект демонстрирует современный подход к разработке Rails приложений с акцентом на:
- **Безопасность** (мультитенантность, авторизация через Pundit)
- **UX** (современный UI с DaisyUI + Lucide иконки)
- **Качество** (комплексное тестирование с RSpec)
- **Производительность** (PostgreSQL, индексы, Solid Cache, tree-shaking)
- **Стандарты сообщества** (Devise, Pundit, RSpec, Hotwire)

Следуя этому руководству, можно воспроизвести проект за 4-6 часов вместо недель экспериментов.

## Ключевые принципы

1. **Стандарты сообщества** — использовать проверенные гемы и подходы, принятые в Rails экосистеме
2. **Производительность с первого дня** — думать о производительности на этапе проектирования, а не после
3. **Минимализм** — не добавлять лишние зависимости, использовать tree-shaking где возможно
4. **Безопасность по умолчанию** — изоляция данных и авторизация должны быть заложены в архитектуру
5. **Современный подход** — использовать актуальные инструменты и практики разработки
6. **Итеративность** — идти небольшими шагами, тестировать каждый этап
7. **Документирование** — фиксировать решения и подходы для будущих итераций
8. **Полная автономность** — агент должен самостоятельно управлять всем жизненным циклом проекта: от создания до мониторинга CI/CD
